<!doctype html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doozy News</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 0; background: #0b1020; color: #e8ecff; }
      .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
      h1 { margin: 0 0 6px; text-align:center; }
      .sub { color: #a9b4e7; margin-bottom: 10px; text-align:center; }
      .topline { display:flex; flex-direction:column; gap:8px; margin:8px 0; width:100%; }
      .controls-grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; width:100%; }
      .mini-select,.refresh-btn { background:#26346a; border:1px solid #3a4a8e; color:#fff; border-radius:8px; padding:10px; font-size:14px; }
      .meta { color:#99a6dd; font-size:12px; text-align:center; min-height:18px; }
      .grid { display:grid; gap:8px; grid-template-columns:1fr; margin-top:10px; }
      .card { background: #141b34; border: 1px solid #283157; border-radius: 10px; padding: 10px 12px; }
      .title { font-size:20px; font-weight:700; line-height:1.25; margin-bottom:6px; }
      .title a { color:#dbe2ff; text-decoration:none; }
      .title a:hover { text-decoration:underline; }
      .row { display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; }
      .chip { font-size:11px; border:1px solid #3a4a8e; color:#cdd7ff; border-radius:999px; padding:2px 8px; }
      .footer-brand { position: fixed; bottom: 6px; left: 0; right: 0; text-align: center; font-size: 10px; color: #7f8dc6; opacity: .9; pointer-events: none; }
      .warn { color:#ffd27f; text-align:center; }
      .reader { position:fixed; inset:0; background:rgba(5,8,18,.92); display:none; z-index:999; }
      .reader.open { display:block; }
      .reader-box { max-width:100%; height:100%; margin:0; padding:0; overflow:auto; }
      .reader-card { background:#0b1020; border:1px solid #283157; border-radius:12px; padding:12px 12px 24px; min-height:100%; margin:8px; }
      .reader-title { font-size:24px; font-weight:700; margin:8px 0 8px; text-align:right; }
      .reader-actions { display:flex; gap:8px; margin-bottom:6px; justify-content:flex-start; }
      .reader-p { color:#dfe5ff; line-height:1.7; margin:0 0 10px; }
      .webview-content { width:100%; min-height:70vh; border:0; background:#0b1020; border-radius:8px; color:#e8ecff; padding:0 2px 24px; box-sizing:border-box; overflow:auto; }
      .dev-only { display:none; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Doozy News</h1>

      <div class="topline">
        <div class="controls-grid">
          <select id="sourceSelect" class="mini-select">
            <option value="all">כל האתרים</option>
            <option value="biz">כלכלה</option>
            <option value="general">חדשות כלליות</option>
            <option value="tech">טכנולוגיה</option>
          </select>
          <button id="refreshBtn" class="refresh-btn">רענן חדשות</button>
        </div>
        <div id="backendDev" class="controls-grid dev-only">
          <input id="backendUrl" class="mini-select" placeholder="Backend URL לחילוץ כתבות מלאות" style="text-align:left;direction:ltr;" />
          <button id="saveBackendBtn" class="refresh-btn">שמור Backend</button>
        </div>
        <div id="status" class="meta">טוען...</div>
      </div>

      <div id="newsGrid" class="grid"></div>
    </div>

    <div id="reader" class="reader">
      <div class="reader-box">
        <div class="reader-card">
          <div class="reader-actions">
            <button id="closeReader" class="refresh-btn">סגור</button>
                      </div>
          <div id="readerTitle" class="reader-title">טוען...</div>
          <div id="readerMeta" class="meta"></div>
          <div id="readerBody"></div>
        </div>
      </div>
    </div>

    <div id="footerBrand" class="footer-brand">Doozy Software Inc. · Build 2026-02-20 05:10</div>

    <script>
      const statusEl = document.getElementById('status');
      const gridEl = document.getElementById('newsGrid');
      const readerEl = document.getElementById('reader');
      const readerTitleEl = document.getElementById('readerTitle');
      const readerMetaEl = document.getElementById('readerMeta');
      const readerBodyEl = document.getElementById('readerBody');
      let currentArticleUrl = '';
      const articleMap = new Map();
      const LS_BACKEND = 'doozy_news_backend_v1';
      const DEFAULT_BACKEND = 'https://doozy-news-extractor.onrender.com';



      function getBackendBase() {
        return (localStorage.getItem(LS_BACKEND) || DEFAULT_BACKEND || '').trim().replace(/\/$/, '');
      }
      function setBackendBase(v) {
        const clean = String(v || '').trim().replace(/\/$/, '');
        if (clean) localStorage.setItem(LS_BACKEND, clean); else localStorage.removeItem(LS_BACKEND);
      }
      function apiUrl(path) {
        const b = getBackendBase();
        return b ? `${b}${path}` : path;
      }
      async function fetchJson(url) {
        const r = await fetch(url);
        const t = await r.text();
        try { return JSON.parse(t); } catch { return { ok:false, error:'non_json' }; }
      }

      let SOURCES = {
        all: [
          { name: 'Google News HE', url: 'https://news.google.com/rss?hl=he&gl=IL&ceid=IL:he' },
          { name: 'Google Business HE', url: 'https://news.google.com/rss/headlines/section/topic/BUSINESS?hl=he&gl=IL&ceid=IL:he' },
          { name: 'כלכליסט', url: 'https://www.calcalist.co.il/GeneralRSS/0,16335,L-8,00.xml' },
          { name: 'גלובס', url: 'https://www.globes.co.il/webservice/rss/rssfeeder.asmx/FeederNode?iID=2' },
          { name: 'דה מרקר', url: 'https://www.themarker.com/cmlink/1.628' },
          { name: 'ynet', url: 'https://www.ynet.co.il/Integration/StoryRss2.xml' },
          { name: 'N12', url: 'https://www.mako.co.il/rss-news?partner=rss' }
        ],
        biz: [
          { name: 'Google Business HE', url: 'https://news.google.com/rss/headlines/section/topic/BUSINESS?hl=he&gl=IL&ceid=IL:he' },
          { name: 'כלכליסט', url: 'https://www.calcalist.co.il/GeneralRSS/0,16335,L-8,00.xml' },
          { name: 'גלובס', url: 'https://www.globes.co.il/webservice/rss/rssfeeder.asmx/FeederNode?iID=2' },
          { name: 'דה מרקר', url: 'https://www.themarker.com/cmlink/1.628' }
        ],
        general: [
          { name: 'Google News HE', url: 'https://news.google.com/rss?hl=he&gl=IL&ceid=IL:he' },
          { name: 'ynet', url: 'https://www.ynet.co.il/Integration/StoryRss2.xml' },
          { name: 'N12', url: 'https://www.mako.co.il/rss-news?partner=rss' }
        ],
        tech: [
          { name: 'Google Tech HE', url: 'https://news.google.com/rss/search?q=%D7%98%D7%9B%D7%A0%D7%95%D7%9C%D7%95%D7%92%D7%99%D7%94&hl=he&gl=IL&ceid=IL:he' },
          { name: 'כלכליסט', url: 'https://www.calcalist.co.il/GeneralRSS/0,16335,L-8,00.xml' },
          { name: 'גלובס', url: 'https://www.globes.co.il/webservice/rss/rssfeeder.asmx/FeederNode?iID=607' }
        ]
      };
      let remoteHideSelectors = [];

      async function loadRemoteConfig() {
        try {
          const src = await fetchJson(apiUrl('/api/sources'));
          if (src?.ok && src?.sources) SOURCES = src.sources;
        } catch {}
        try {
          const rules = await fetchJson(apiUrl('/api/ad-rules'));
          if (rules?.ok && Array.isArray(rules?.rules?.hideSelectors)) {
            remoteHideSelectors = rules.rules.hideSelectors;
          }
        } catch {}
      }

      async function httpText(url) {
        const capHttp = window.CapacitorHttp || window.Capacitor?.Plugins?.CapacitorHttp;
        const isNative = !!window.Capacitor?.isNativePlatform?.();
        if (isNative && capHttp?.get) {
          const r = await capHttp.get({ url, headers: { 'Cache-Control': 'no-cache' } });
          return typeof r.data === 'string' ? r.data : JSON.stringify(r.data);
        }
        const r = await fetch(url);
        return await r.text();
      }


      async function httpTextWithTimeout(url, timeoutMs = 7000) {
        return await Promise.race([
          httpText(url),
          new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), timeoutMs))
        ]);
      }

      function escapeHtml(str) {
        return String(str || "").replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#39;");
      }

      function parseItems(xmlText, fallbackSource) {
        const doc = new DOMParser().parseFromString(xmlText, 'text/xml');
        const items = [...doc.querySelectorAll('item')].map((it) => {
          const title = (it.querySelector('title')?.textContent || '').trim();
          const link = (it.querySelector('link')?.textContent || '').trim();
          const source = (it.querySelector('source')?.textContent || fallbackSource || '').trim();
          const pubDate = (it.querySelector('pubDate')?.textContent || '').trim();
          const rawDesc = (it.querySelector('description')?.textContent || '').trim();
          const desc = rawDesc.replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
          const ts = Date.parse(pubDate || '') || 0;
          return { title, link, source, pubDate, ts, desc };
        }).filter(x => x.title && x.link);
        return items;
      }

      function uniqByLink(items) {
        const seen = new Set();
        return items.filter((it) => {
          if (seen.has(it.link)) return false;
          seen.add(it.link);
          return true;
        });
      }

      async function fetchRaw(url) {
        const capHttp = window.CapacitorHttp || window.Capacitor?.Plugins?.CapacitorHttp;
        const isNative = !!window.Capacitor?.isNativePlatform?.();
        if (isNative && capHttp?.get) {
          const r = await capHttp.get({ url, headers: { 'User-Agent': 'Mozilla/5.0' } });
          return typeof r.data === 'string' ? r.data : JSON.stringify(r.data || '');
        }
        const r = await fetch(url);
        return await r.text();
      }

      async function fetchViaReaderProxy(url) {
        const clean = String(url || '').trim();
        if (!clean) return '';
        const noScheme = clean.replace(/^https?:\/\//i, '');
        const proxyUrl = `https://r.jina.ai/http://${noScheme}`;
        try {
          return await fetchRaw(proxyUrl);
        } catch {
          return '';
        }
      }

      function extractReadable(html) {
        const doc = new DOMParser().parseFromString(html, 'text/html');
        [...doc.querySelectorAll('script,style,noscript,iframe,header,footer,nav,aside,.ad,.ads,.advertisement,[role="banner"]')].forEach(el => el.remove());
        const localHide = ['[id*="ad"]','[class*="ad-"]','[class*="advert"]','[class*="banner"]','[class*="popup"]','.paywall','.newsletter','.recommended'];
        const allHide = [...new Set([...localHide, ...remoteHideSelectors])];
        allHide.forEach(sel => { try { doc.querySelectorAll(sel).forEach(el => el.remove()); } catch {} });
        const container = doc.querySelector('article') || doc.querySelector('main') || doc.body;
        const title = (doc.querySelector('meta[property="og:title"]')?.content || doc.querySelector('title')?.textContent || '').trim();
        const paragraphs = [...container.querySelectorAll('p')]
          .map(p => (p.textContent || '').trim())
          .filter(t => t.length > 50)
          .slice(0, 70);
        return { title, paragraphs };
      }


      function parseProxyText(txt) {
        const lines = String(txt || '').split('\n').map(l => l.trim()).filter(Boolean);
        const titleLine = lines.find(l => l.startsWith('Title: ')) || '';
        const title = titleLine.replace(/^Title:\s*/, '').trim();
        const bodyStart = lines.findIndex(l => l.startsWith('Markdown Content:'));
        const bodyLines = bodyStart >= 0 ? lines.slice(bodyStart + 1) : lines;
        const paragraphs = bodyLines
          .join('\n')
          .split(/\n{2,}/)
          .map(p => p.replace(/^#+\s*/, '').trim())
          .filter(p => p.length > 80)
          .slice(0, 80);
        return { title, paragraphs };
      }

      async function openArticle(url, fallbackTitle='', fallbackSnippet='') {
        currentArticleUrl = url;
        readerEl.classList.add('open');
        readerTitleEl.textContent = fallbackTitle || 'טוען כתבה...';
        readerMetaEl.textContent = 'טוען כתבה מלאה...';
        readerBodyEl.innerHTML = `<div class="webview-content">טוען...</div>`;
        try {
          const j = await fetchJson(apiUrl(`/api/webview?url=${encodeURIComponent(url)}`));
          if (j?.ok && j?.html) {
            readerBodyEl.innerHTML = `<div class="webview-content">${j.html}</div>`;
            readerMetaEl.textContent = 'מצב קריאה פנימי (ניקוי פרסומות)';
            if (j?.title) readerTitleEl.textContent = j.title;
            return;
          }
          throw new Error(j?.error || 'backend_unavailable');
        } catch {
          // Local fallback via CapacitorHttp: keep same design and avoid blank screen
          try {
            const raw = await fetchRaw(url);
            const parsed = extractReadable(raw);
            const paragraphs = (parsed?.paragraphs || []).slice(0, 140);
            if (paragraphs.length) {
              readerTitleEl.textContent = parsed.title || fallbackTitle || 'כתבה';
              readerMetaEl.textContent = 'מצב קריאה פנימי (fallback מקומי)';
              readerBodyEl.innerHTML = `<div class="webview-content">${paragraphs.map(p => `<p class="reader-p">${escapeHtml(p)}</p>`).join('')}</div>`;
            } else {
              throw new Error('no_text');
            }
          } catch (e2) {
            readerMetaEl.textContent = 'לא ניתן לטעון כתבה מלאה כרגע';
            const snip = fallbackSnippet ? `<p class="reader-p">${escapeHtml(fallbackSnippet)}</p>` : '';
            readerBodyEl.innerHTML = `<div class="webview-content"><div class="warn">לא ניתן לטעון כתבה מלאה כרגע.</div>${snip}</div>`;
          }
        }
      }

      async function loadNews(force = false) {
        const mode = document.getElementById('sourceSelect').value;
        const feeds = SOURCES[mode] || SOURCES.all;
        const prevH = gridEl.offsetHeight;
        if (prevH > 0) gridEl.style.minHeight = `${prevH}px`;
        statusEl.textContent = 'טוען כותרות...';

        const requests = feeds.map(async (f) => {
          const bust = force ? (f.url.includes('?') ? '&' : '?') + 't=' + Date.now() : '';
          const xml = await httpTextWithTimeout(f.url + bust, 7000);
          return parseItems(xml, f.name);
        });
        const settled = await Promise.allSettled(requests);
        const all = [];
        let okFeeds = 0;
        for (const r of settled) {
          if (r.status === 'fulfilled') {
            okFeeds += 1;
            all.push(...(r.value || []));
          }
        }

        const rows = uniqByLink(all).sort((a,b) => b.ts - a.ts).slice(0, 60);
        gridEl.innerHTML = '';

        if (!rows.length) {
          gridEl.innerHTML = '<div class="card warn">לא הצלחתי למשוך כותרות כרגע. ייתכן שחלק מהמקורות איטיים/חסומים כרגע. נסה שוב בעוד דקה.</div>';
          statusEl.textContent = 'אין נתונים כרגע';
          gridEl.style.minHeight = '';
          return;
        }

        const frag = document.createDocumentFragment();
        articleMap.clear();
        for (const n of rows) {
          const div = document.createElement('div');
          div.className = 'card';
          const when = n.ts ? new Date(n.ts).toLocaleString('he-IL', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' }) : (n.pubDate || '');
          articleMap.set(n.link, n);
          div.innerHTML = `
            <div class="title open-article" data-url="${n.link.replace(/"/g, "&quot;")}" data-title="${escapeHtml(n.title)}" style="cursor:pointer;">${escapeHtml(n.title)}</div>
            <div class="row">
              <div class="meta">${when}</div>
              <div class="chip">${escapeHtml(n.source || 'מקור לא ידוע')}</div>
            </div>
          `;
          frag.appendChild(div);
        }
        gridEl.appendChild(frag);
        statusEl.textContent = `נטענו ${rows.length} כותרות (${okFeeds}/${feeds.length} מקורות)`;
        if (!rows.length) statusEl.textContent = `אין כותרות כרגע (${okFeeds}/${feeds.length} מקורות הצליחו)`;
        requestAnimationFrame(() => { gridEl.style.minHeight = ''; });
      }

      document.getElementById('refreshBtn').addEventListener('click', () => loadNews(true));
      document.getElementById('sourceSelect').addEventListener('change', () => loadNews(true));
      document.addEventListener('click', (e) => {
        const a = e.target.closest('a');
        if (a) { e.preventDefault(); e.stopPropagation(); }
      }, true);

      gridEl.addEventListener('click', (e) => {
        const anyA = e.target.closest('a');
        if (anyA) e.preventDefault();
      }, true);
      gridEl.addEventListener('click', (e) => {
        const a = e.target.closest('.open-article');
        if (!a) return;
        e.preventDefault();
        const u = a.getAttribute('data-url') || '';
        const item = articleMap.get(u);
        openArticle(u, a.getAttribute('data-title') || a.textContent || '', item?.desc || '');
      });
      document.getElementById('closeReader').addEventListener('click', () => { readerEl.classList.remove('open'); });
      const devMode = new URLSearchParams(location.search).get('dev') === '1';
      const backendDev = document.getElementById('backendDev');
      const backendInput = document.getElementById('backendUrl');
      const saveBackendBtn = document.getElementById('saveBackendBtn');
      if (devMode && backendDev) backendDev.style.display = 'grid';
      if (backendInput) backendInput.value = getBackendBase();
      if (saveBackendBtn) saveBackendBtn.addEventListener('click', () => {
        setBackendBase(backendInput.value || '');
        statusEl.textContent = getBackendBase() ? 'Backend נשמר לחילוץ כתבות מלאות' : 'Backend הוסר';
      });

      (async () => {
        await loadRemoteConfig();
        await loadNews();
      })();
      setInterval(async () => { await loadRemoteConfig(); await loadNews(false); }, 5 * 60 * 1000);
    </script>
  </body>
</html>
