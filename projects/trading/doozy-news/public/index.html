<!doctype html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doozy News</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 0; background: #0b1020; color: #e8ecff; }
      .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
      h1 { margin: 0 0 6px; text-align:center; }
      .sub { color: #a9b4e7; margin-bottom: 10px; text-align:center; }
      .topline { display:flex; flex-direction:column; gap:8px; margin:8px 0; width:100%; }
      .controls-grid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; width:100%; }
      .mini-select,.refresh-btn { background:#26346a; border:1px solid #3a4a8e; color:#fff; border-radius:8px; padding:10px; font-size:14px; }
      .meta { color:#99a6dd; font-size:12px; text-align:center; min-height:18px; }
      .grid { display:grid; gap:8px; grid-template-columns:1fr; margin-top:10px; }
      .card { background: #141b34; border: 1px solid #283157; border-radius: 10px; padding: 10px 12px; }
      .title { font-size:20px; font-weight:700; line-height:1.25; margin-bottom:6px; }
      .title a { color:#dbe2ff; text-decoration:none; }
      .title a:hover { text-decoration:underline; }
      .row { display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; }
      .chip { font-size:11px; border:1px solid #3a4a8e; color:#cdd7ff; border-radius:999px; padding:2px 8px; }
      .footer-brand { position: fixed; bottom: 6px; left: 0; right: 0; text-align: center; font-size: 10px; color: #7f8dc6; opacity: .9; pointer-events: none; }
      .warn { color:#ffd27f; text-align:center; }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Doozy News</h1>
      <div class="sub">אגרגציית חדשות בעברית · עיצוב Doozy Dashboard</div>

      <div class="topline">
        <div class="controls-grid">
          <select id="sourceSelect" class="mini-select">
            <option value="all">כל האתרים</option>
            <option value="biz">כלכלה</option>
            <option value="general">חדשות כלליות</option>
            <option value="tech">טכנולוגיה</option>
          </select>
          <button id="refreshBtn" class="refresh-btn">רענן חדשות</button>
        </div>
        <div id="status" class="meta">טוען...</div>
      </div>

      <div id="newsGrid" class="grid"></div>
    </div>

    <div id="footerBrand" class="footer-brand">Doozy Software Inc. · Build 2026-02-19 23:45</div>

    <script>
      const statusEl = document.getElementById('status');
      const gridEl = document.getElementById('newsGrid');

      const SOURCES = {
        all: [
          { name: 'כלכליסט', url: 'https://www.calcalist.co.il/GeneralRSS/0,16335,L-8,00.xml' },
          { name: 'גלובס', url: 'https://www.globes.co.il/webservice/rss/rssfeeder.asmx/FeederNode?iID=2' },
          { name: 'דה מרקר', url: 'https://www.themarker.com/cmlink/1.628' },
          { name: 'ynet', url: 'https://www.ynet.co.il/Integration/StoryRss2.xml' },
          { name: 'N12', url: 'https://www.mako.co.il/rss-news?partner=rss' }
        ],
        biz: [
          { name: 'כלכליסט', url: 'https://www.calcalist.co.il/GeneralRSS/0,16335,L-8,00.xml' },
          { name: 'גלובס', url: 'https://www.globes.co.il/webservice/rss/rssfeeder.asmx/FeederNode?iID=2' },
          { name: 'דה מרקר', url: 'https://www.themarker.com/cmlink/1.628' }
        ],
        general: [
          { name: 'ynet', url: 'https://www.ynet.co.il/Integration/StoryRss2.xml' },
          { name: 'N12', url: 'https://www.mako.co.il/rss-news?partner=rss' }
        ],
        tech: [
          { name: 'כלכליסט', url: 'https://www.calcalist.co.il/GeneralRSS/0,16335,L-8,00.xml' },
          { name: 'גלובס', url: 'https://www.globes.co.il/webservice/rss/rssfeeder.asmx/FeederNode?iID=607' }
        ]
      };

      async function httpText(url) {
        const capHttp = window.CapacitorHttp || window.Capacitor?.Plugins?.CapacitorHttp;
        const isNative = !!window.Capacitor?.isNativePlatform?.();
        if (isNative && capHttp?.get) {
          const r = await capHttp.get({ url, headers: { 'Cache-Control': 'no-cache' } });
          return typeof r.data === 'string' ? r.data : JSON.stringify(r.data);
        }
        const r = await fetch(url);
        return await r.text();
      }

      function parseItems(xmlText, fallbackSource) {
        const doc = new DOMParser().parseFromString(xmlText, 'text/xml');
        const items = [...doc.querySelectorAll('item')].map((it) => {
          const title = (it.querySelector('title')?.textContent || '').trim();
          const link = (it.querySelector('link')?.textContent || '').trim();
          const source = (it.querySelector('source')?.textContent || fallbackSource || '').trim();
          const pubDate = (it.querySelector('pubDate')?.textContent || '').trim();
          const ts = Date.parse(pubDate || '') || 0;
          return { title, link, source, pubDate, ts };
        }).filter(x => x.title && x.link);
        return items;
      }

      function uniqByLink(items) {
        const seen = new Set();
        return items.filter((it) => {
          if (seen.has(it.link)) return false;
          seen.add(it.link);
          return true;
        });
      }

      async function loadNews(force = false) {
        const mode = document.getElementById('sourceSelect').value;
        const feeds = SOURCES[mode] || SOURCES.all;
        const prevH = gridEl.offsetHeight;
        if (prevH > 0) gridEl.style.minHeight = `${prevH}px`;
        statusEl.textContent = 'טוען כותרות...';

        const all = [];
        for (const f of feeds) {
          try {
            const bust = force ? (f.url.includes('?') ? '&' : '?') + 't=' + Date.now() : '';
            const xml = await httpText(f.url + bust);
            all.push(...parseItems(xml, f.name));
          } catch {}
        }

        const rows = uniqByLink(all).sort((a,b) => b.ts - a.ts).slice(0, 60);
        gridEl.innerHTML = '';

        if (!rows.length) {
          gridEl.innerHTML = '<div class="card warn">לא הצלחתי למשוך כותרות כרגע. ננסה שוב ברענון.</div>';
          statusEl.textContent = 'אין נתונים כרגע';
          gridEl.style.minHeight = '';
          return;
        }

        const frag = document.createDocumentFragment();
        for (const n of rows) {
          const div = document.createElement('div');
          div.className = 'card';
          const when = n.ts ? new Date(n.ts).toLocaleString('he-IL', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' }) : (n.pubDate || '');
          div.innerHTML = `
            <div class="title"><a href="${n.link}" target="_blank" rel="noopener">${n.title}</a></div>
            <div class="row">
              <div class="meta">${when}</div>
              <div class="chip">${n.source || 'מקור לא ידוע'}</div>
            </div>
          `;
          frag.appendChild(div);
        }
        gridEl.appendChild(frag);
        statusEl.textContent = `נטענו ${rows.length} כותרות`;
        requestAnimationFrame(() => { gridEl.style.minHeight = ''; });
      }

      document.getElementById('refreshBtn').addEventListener('click', () => loadNews(true));
      document.getElementById('sourceSelect').addEventListener('change', () => loadNews(true));

      loadNews();
      setInterval(() => loadNews(false), 5 * 60 * 1000);
    </script>
  </body>
</html>
